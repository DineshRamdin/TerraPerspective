@{
    ViewData["Title"] = "Task";
}
@using UI.Resources
@using BL.Models.Administration;
@model TaskCRUDDTO;
<link href="~/plugins/dropdowntree/dropdowntree.css" rel="stylesheet" />

<style>
    label {
        margin-bottom: 0; /* Prevents extra spacing under the label */
    }

    input[type="checkbox"] {
        margin: 0; /* Removes any unwanted margin */
    }


    /* Ensure checkboxes inside the dropdown are visible */
    .checkbox {
        margin-right: 10px;
        display: inline-block;
    }

    /* Style for the dropdown items */
    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 5px;
    }

        .dropdown-item label {
            cursor: pointer;
        }
    /* Separator after the first item */
    .dropdown-menu li:not(:first-child) {
        border-top: 1px solid #e0e0e0; /* Light gray separator */
        margin-top: 5px;
    }
</style>

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">@SharedResource.Task</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-area="" asp-controller="Dashboard" asp-action="index">@SharedResource.Home</a></li>
                    <li class="breadcrumb-item active">@SharedResource.Task</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->
<section class="content">
    <div class="container-fluid">
        <div class="card card-solid">
            <div class="card-body pb-0">
                <div class="row">
                    <div class="col-10">
                    </div>
                </div>
                <div class="form-panel" id="formTaskAddEdit">
                    <div class="row">
                        @* Hidden field for Task ID *@
                        <div class="form-floating d-none">
                            @Html.TextBoxFor(m => m.Id, new { @class = "form-control", @result = "Id", @id = "hdnId", @type = "text", @placeholder = "Id" })
                        </div>

                        <div class="col-3 form-group">
                            <label>@SharedResource.Task_Code<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.UserCode, new { @class = "form-control", @result = "UserCode", @placeholder = SharedResource.Task_Code, @readonly = "readonly" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Task_Name<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.TaskName, new { @class = "form-control", @result = "TaskName", @placeholder = SharedResource.Task_Name, @required = "required" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Parent_Task<span class="red-required">*</span></label>
                            <select class="form-control" id="ddlParentTask" required></select>
                        </div>

                        <div class="col-3 form-group">
                            <label>@SharedResource.Projects<span class="red-required">*</span></label>
                            <select class="form-control" id="ddlProjects" required></select>
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Status<span class="red-required">*</span></label>
                            <select class="form-control" id="ddlStatus" required></select>
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Percentage<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.Percentage, new { @class = "form-control", @result = "Percentage", @min = "0", @max = "100", @placeholder = SharedResource.Percentage, @required = "required" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Start_Date<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.StartDate, "{0:yyyy-MM-dd}", new { @class = "form-control", @result = "StartDate", @type = "date", @placeholder = SharedResource.Start_Date, @required = "required" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.End_Date<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.EndDate, "{0:yyyy-MM-dd}", new { @class = "form-control", @result = "EndDate", @type = "date", @placeholder = SharedResource.End_Date, @required = "required" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Task_Description<span class="red-required">*</span></label>
                            @Html.TextAreaFor(m => m.TaskDescription, new { @class = "form-control", @result = "TaskDescription", @placeholder = SharedResource.Task_Description, @required = "required" })
                        </div>
                        <div class="col-3 form-group">
                            <label>@SharedResource.Folder<span class="red-required">*</span></label>
                            @Html.TextBoxFor(m => m.Folder, new { @class = "form-control", @type = "text", @id = "txtFolder", @required = "required", @name = "txtFolder", @result = "Folder" })
                        </div>
                        <div class="col-4 row form-group clearfix">
                            <div class="col-4 d-flex align-items-center">
                                <label for="chbIsVisible" class="mr-2">@SharedResource.Is_Visible</label>
                                @Html.CheckBoxFor(m => m.IsVisible.HasValue, new { @class = "form-control-sm", @result = "IsVisible" })

                            </div>
                        </div>

                    </div>
                    <div class="row mb-2"></div>
                    <div class="row">
                        <div class="col-3 mb-2">
                            <button type="button" class="btn btn-primary mr-2" onclick="SaveTask();">@SharedResource.Save</button>
                            <a href="@Url.Action("Index","Task")" type="button" class="btn btn-default">Back To List</a>
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </div>
</section>
@section scripts
{
    <script src="~/plugins/dropdowntree/dropdowntree.js"></script>
    <script>
        var GetAllTaskUrl = '@Url.Action("GetAll", "Task")';
        var TaskGetByIdUrl = '@Url.Action("GetById", "Task")';
        var CreateUpdateTaskUrl = '@Url.Action("CreateUpdate", "Task")';
        var getTaskDropDownUrl = '@Url.Action("GetAllDropdownValues", "Task")';

        var Project = '@Model.Project';
        var ParentTask = '@Model.ParentTask';
        var Status = '@Model.Status';
        var TaskId = '@Model.Id';

        $(function () {
            $('.nav-link').removeClass('active');
            $('#liTaskmenu').addClass('active');

            if ($('#StartDate').val() === '0001-01-01') {
                $('#StartDate').val('');
            }

            if ($('#EndDate').val() === '0001-01-01') {
                $('#EndDate').val('');
            }

            GetDropdownData();
        });

        function GetDropdownData() {
            $.ajax({
                url: getTaskDropDownUrl,
                type: "POST",
                async: false,
                // data: dataObject,  // Send data if needed
                beforeSend: function () {
                    $("#ddlProjects").html('');
                    $("#ddlStatus").html('');
                    $("#ddlParentTask").html('');
                },
                success: function (response) {
                    if (response.data) {
                        $.each(response.data, function (key, value) {
                            if (value.title == "Projects") {
                                $("#ddlProjects").append($("<option></option>").val('').html("@SharedResource.Select_Project"));
                                $.each(value.items, function (itemskey, itemsvalue) {
                                    $("#ddlProjects").append($("<option></option>").val(itemsvalue.id).html(itemsvalue.text));
                                });
                                if (Project != null)
                                    $("#ddlProjects").val(Project);
                            }

                            if (value.title == "Project Status") {
                                $("#ddlStatus").append($("<option></option>").val('').html("@SharedResource.Select_Status"));
                                $.each(value.items, function (itemskey, itemsvalue) {
                                    $("#ddlStatus").append($("<option></option>").val(itemsvalue.id).html(itemsvalue.text));
                                });
                                if (Status != null)
                                    $("#ddlStatus").val(Status);
                            }

                            if (value.title == "ParentTask") {
                                $("#ddlParentTask").append($("<option></option>").val('').html("Select Parent Task"));
                                $.each(value.items, function (itemskey, itemsvalue) {
                                    $("#ddlParentTask").append($("<option></option>").val(itemsvalue.id).html(itemsvalue.text));
                                });
                                if (ParentTask != null)
                                    $("#ddlParentTask").val(ParentTask);
                            }
                        });
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                    // toastr.error("Error:" + error);
                }

            });
        }



        function SaveTask() {

            var dataObject = {};
            var data = result(document.getElementById("formTaskAddEdit"));
            data["Project"] = $("#ddlProjects").val();
            data["ParentTask"] = $("#ddlParentTask").val();
            data["Status"] = $("#ddlStatus").val();

            $.ajax({
                url: CreateUpdateTaskUrl,
                type: "POST",
                data: data,  // Send data if needed
                beforeSend: function () {

                },
                success: function (response) {
                    if (response.data) {
                        toastr.success(response.errorMessage);
                        $('#AddTaskModal').modal('hide');
                        GetAllTask();
                    }
                    else {
                        toastr.error(response.errorMessage);
                    }
                    // Handle success (e.g., update UI with response data)
                },
                error: function (error) {
                    console.log("Error:", error);
                    toastr.error("Error:" + error);
                }
            }).done(function () {

            });

        }

    </script>
}