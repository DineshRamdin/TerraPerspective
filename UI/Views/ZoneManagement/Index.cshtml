@{
    ViewData["Title"] = "Zone Management";
}

<link href="~/plugins/leaflet-1.7.1/leaflet.css" rel="stylesheet" />
<link href="~/plugins/leaflet-draw-1.0.4/leaflet.draw.css" rel="stylesheet" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<style>
    #map {
        width: 100%;
        height: 85vh; /* Full viewport height */
    }

    #ZoneManagementTable > tbody > .selected-row {
        background: #cce5ff;
        border-color: #cce5ff;
    }

    .leaflet-bar input {
        width: 200px;
        padding: 5px;
        position: relative;
        z-index: 1000; /* Ensure it's above the map */
    }

    /* Ensure that autocomplete suggestions don't overflow and stay within the map bounds */
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        z-index: 9999 !important;
    }

     /* Base container styling */
        .search-control {
            position: relative;
            width: 40px; /* Show only the icon initially */
            height: 40px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            transition: width 0.3s ease; /* Smooth expansion */
        }

        /* Input box styling */
        .search-input {
            width: 0;
            height: 100%;
            border: none;
            padding: 0 10px;
            outline: none;
            opacity: 0;
            transition: width 0.3s ease, opacity 0.3s ease;
        }

        /* Search icon styling */
        .search-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            cursor: pointer;
        }

        /* Show the input box on hover */
        .search-control:hover {
            width: 200px; /* Expanded width */
        }

        .search-control:hover .search-input {
            width: 100%;
            opacity: 1;
        }

        .search-control:hover .search-icon {
            display: none; /* Hide the icon when expanded */
        }
</style>

<!-- Content Header (Page header) -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Zone Management</h1>
            </div><!-- /.col -->
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-area="" asp-controller="Dashboard" asp-action="index">Home</a></li>
                    <li class="breadcrumb-item active">Zone Management</li>
                </ol>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>
<!-- /.content-header -->


<section class="content">
    <div class="container-fluid">
        <div class="card card-solid">
            <div class="card-body pb-0">
                <div class="row">
                    <div class="col-10">
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-block btn-primary mb-3" onclick="openZoneManagementModal(0)">Add</button>
                    </div>
                </div>
                <div class="row">
                    @*  <div class="col-2 mb-3">
                    <div id="Zonejstree"></div>
                    </div> *@
                    <div class="col-6  mb-3">
                        <div class="col-12">
                            <table id="ZoneManagementTable" class="table table-bordered table-striped"></table>
                        </div>
                        <div class="col-12" style="display:none" id="AddEditZone">
                            <partial name="_AddZone.cshtml" />
                        </div>
                    </div>

                    <div class="col-6  mb-3">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@* <div class="modal fade" id="AddZoneManagementModal" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <partial name="_AddZoneManagement.cshtml" />
</div> *@

@section scripts
{

    <script src="~/plugins/leaflet-1.7.1/leaflet.js"></script>
    <script src="~/plugins/leaflet-draw-1.0.4/leaflet.draw.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>

        var GetAllZoneManagementUrl = '@Url.Action("GetAll", "ZoneManagement")';
        var GetSelectedZoneDataUrl = '@Url.Action("GetSelectedZoneData", "ZoneManagement")';
        var GetAllZoneUrl = '@Url.Action("GetAllZone", "ZoneManagement")';
        var CreateUpdateZoneManagementUrl = '@Url.Action("CreateUpdate", "ZoneManagement")';
        var ZoneManagementGetByIdUrl = '@Url.Action("GetById", "ZoneManagement")';
        var GetZoneAutocompleteDataUrl = '@Url.Action("GetZoneAutocompleteData", "ZoneManagement")';

        $(function () {
            $('.nav-link').removeClass('active');
            $('#liZoneManagementmenu').addClass('active');

            // BindJsTreeData();
            initMap();
            GetAllZoneManagement();
            // $('#Zonejstree').on('changed.jstree', function (e, data) {
            //     if (data.action != 'ready') { // Ensures it was triggered by node selection Or deselection
            //         initMap();
            //     }
            // });

            $("#ZoneManagementTable").on('click', 'tr', function (event) {
                 var target = $(event.target); // Get the clicked element
                    if(target.is("td"))
                    {

                        $("#ZoneManagementTable").find(".selected-row").removeClass("selected-row");
                        var Id = $(this).attr("data-id")
                        $(this).addClass("selected-row")
                        initMap(Id);
                    }
            });

        });
        function GetAllZoneManagement() {
            var columnList = [
                { data: 'id', title: 'Id', visible: false },
                { data: 'zone', title: 'Zone' },
                { data: 'type', title: 'Type' },
            ];

            initializeDataGrid('ZoneManagementTable', 'openZoneManagementModal', GetAllZoneUrl, columnList, false, false, true, false);

        }
        function BindJsTreeData() {
            var ZoneData = [];
            $.ajax({
                url: GetAllZoneUrl,
                type: "POST",
                async: false,
                // data: dataObject,  // Send data if needed
                beforeSend: function () {
                    ZoneData = [];
                },
                success: function (response) {
                    if (response.data) {
                        ZoneData = response.data;
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                    toastr.error("Error:" + error);
                }
            }).done(function () {
                const groupedData = ZoneData.reduce((acc, item) => {
                    const Type = item.type;
                    if (!acc[Type]) {
                        acc[Type] = { text: Type, children: [] };
                    }
                    acc[Type].children.push({ text: item.zone, Value: item.id });
                    return acc;
                }, {});

                const selectArray = Object.values(groupedData);

                if ($.jstree.reference('#Zonejstree')) {
                    $('#Zonejstree').jstree("destroy").empty(); // Destroy and clear DOM content
                }

                $('#Zonejstree').on('loaded.jstree', function (e, data) {
                    $('#Zonejstree').jstree('select_all'); // Select all nodes once the tree is fully loaded
                }).jstree({
                    'core': {
                        'data': selectArray
                    },
                    "plugins": ["checkbox"] // Enable the checkbox plugin
                });
            });
        }
        function GetSelectedZone() {
            var selectedNodes = $('#Zonejstree').jstree("get_selected", true); // Get selected nodes with full data
            var values = [];

            selectedNodes.forEach(function (node) {
                if (node.original.Value !== undefined) { // Check if Value exists
                    values.push(node.original.Value); // Push the Value to the array
                }
            });
            return values.join(",");
        }

        let map;

        function initMap(selectedZone) {
            var MapData = [];
            // var selectedZone = GetSelectedZone();

            var dataObject = {};
            dataObject.selectedZone = selectedZone == undefined ? "" : selectedZone;

            $.ajax({
                url: selectedZone == undefined ? GetAllZoneManagementUrl : GetSelectedZoneDataUrl,
                type: "POST",
                data: dataObject,  // Send data if needed
                beforeSend: function () {
                    MapData = [];
                },
                success: function (response) {
                    if (response.data) {
                        MapData = response.data;
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                    toastr.error("Error:" + error);
                }
            }).done(function () {

               if (map) {
                    map.remove(); // Destroy the existing map instance if it exists
                    map = null;    // Set it to null to ensure a clean start
                }
                    map = L.map('map').setView([-20.081670, 57.598266], 10);

                    const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);

                    // Base layer: OpenStreetMap
                    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '© OpenStreetMap'
                    }).addTo(map);

                    // Satellite layer (ESRI Satellite)
                    var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri, Maxar, Earthstar Geographics, and the GIS User Community'
                    });

                    // Define base maps for the dropdown
                    var baseMaps = {
                        "Map": osmLayer,
                        "Satellite": satelliteLayer
                    };

                    // Add the custom control to the map

                    var searchControl = L.Control.extend({
                        onAdd: function () {
                            // var container = L.DomUtil.create('div', 'leaflet-bar');
                            // var inputBox = L.DomUtil.create('input', '', container);
                            // inputBox.type = 'text';
                            // inputBox.placeholder = 'Search for a Zone...';
                            // L.DomUtil.addClass(inputBox, 'form-control');

                              // Create the main container
            var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control search-control');

            // Create the input box (hidden by default)
            var inputBox = L.DomUtil.create('input', 'search-input', container);
            inputBox.type = 'text';
            inputBox.placeholder = 'Search for a Zone...';
            L.DomUtil.addClass(inputBox, 'form-control');

            // Create the search icon
            var icon = L.DomUtil.create('span', 'search-icon', container);
            icon.innerHTML = '<i class="fa fa-search"></i>'; // Unicode search icon, can replace with FontAwesome

            // Prevent map interactions when clicking inside the control
            L.DomEvent.disableClickPropagation(container);


                            // jQuery UI Autocomplete
                            $(inputBox).autocomplete({
                                source: function (request, response) {
                                    // Make an AJAX call to the Nominatim API for location search
                                    $.ajax({
                                        url: GetZoneAutocompleteDataUrl,
                                        data: { term: request.term },
                                        success: function (data) {
                                            response(data.data.map(function (item) {
                                                return {
                                                    label: item.zone,  // Displayed in autocomplete
                                                    value: item.zone,  // Selected value
                                                    featureGeoJson: item.featureGeoJson,
                                                };
                                            }));
                                        }
                                    });
                                },
                                select: function (event, ui) {

                                    var geoJsonData = JSON.parse(ui.item.featureGeoJson);

                                    // Add the GeoJSON polygon to the map
                                    var layer = L.geoJSON(geoJsonData).addTo(map);

                                    map.flyToBounds(layer.getBounds(), {
                                        padding: [50, 50],  // Adds padding around the bounds
                                        // maxZoom: 12,        // Sets a maximum zoom level
                                        animate: true,       // Animates the zoom transition
                                        duration: 3 // Duration in seconds
                                    });
                                }
                            });

                            // Ensure the autocomplete dropdown appears correctly
                            $(inputBox).on("focus", function () {
                                setTimeout(() => {
                                    $(".ui-autocomplete").css("position", "absolute");
                                    $(".ui-autocomplete").css("z-index", "9999");
                                }, 100);
                            });

                            return container;
                        }
                       });

                    // Add the custom search control to the map
                    map.addControl(new searchControl({ position: 'topright' }));

                    
                    L.control.layers(baseMaps).addTo(map);

                var bounds = L.latLngBounds();

                // Loop through the data array and process each feature
                MapData.forEach(function (item) {
                    // Parse the GeoJSON string
                    var geoJsonData = JSON.parse(item.featureGeoJson);

                    // Add the GeoJSON polygon to the map
                    var layer = L.geoJSON(geoJsonData).addTo(map);

                    bounds.extend(layer.getBounds());
                });

                // Fit the map to the accumulated bounds
                if (bounds.isValid()) {
                    map.flyToBounds(bounds, {
                        padding: [50, 50],  // Adds padding around the bounds
                        // maxZoom: 12,        // Sets a maximum zoom level
                        animate: true,       // Animates the zoom transition
                        duration: 3 // Duration in seconds
                    });

                }
            });

        }

        function openZoneManagementModal(id) {
            var dataObject = {};
            dataObject.id = id;
            var existingGeoJson = "";
            $.ajax({
                url: ZoneManagementGetByIdUrl,
                type: "POST",
                data: dataObject,  // Send data if needed
                beforeSend: function () {
                    ClearZoneManagementModal();
                },
                success: function (response) {
                    if (response.data) {
                        console.log("response.data", response.data);
                        if (response.data.id > 0)
                            $("#h4ZoneManagementTitle").html("Modify Geomerty Data");
                        else {
                            $("#h4ZoneManagementTitle").html("Add Geomerty Data");
                        }

                        $("#hdnId").val(response.data.id);
                        $("#txtZone").val(response.data.zone);
                        $("#txtType").val(response.data.type);


                        if (response.data.featureGeoJson != null) {
                            existingGeoJson = JSON.parse(response.data.featureGeoJson)
                            $('#hdnMapdata').val(ConvertGeoJSONtoWKT(response.data.featureGeoJson));
                        }
                    }
                    else {
                        toastr.error(response.errorMessage);
                    }
                    // Handle success (e.g., update UI with response data)
                },
                error: function (error) {
                    console.log("Error:", error);
                    toastr.error("Error:" + error);
                }
            }).done(function () {

                // $('#AddZoneManagementModal').modal('show');
                $("#AddEditZone").css('display','');
                $("#frnZoneManagementCreate").validate({}).resetForm();

                if (map) {
                    map.remove(); // Destroy the existing map instance if it exists
                    map = null;    // Set it to null to ensure a clean start
                }

                // Createmap = L.map('Createmap').setView([51.505, -0.09], 13);
                map = L.map('map').setView([-20.081670, 57.598266], 12);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19
                }).addTo(map);


                // Add drawing control
                var drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);

                var drawControl = new L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems,
                        remove: true
                    },
                    draw: {
                        polygon: true,
                        polyline: false,
                        rectangle: false,
                        circle: false,
                        marker: false,
                        circlemarker: false
                    }
                });
                map.addControl(drawControl);

                if (existingGeoJson) {
                    L.geoJSON(existingGeoJson).eachLayer(function (layer) {
                        drawnItems.addLayer(layer); // Ensure drawnItems exists here
                    });
                }

                // Handle the creation of polygons
                map.on(L.Draw.Event.CREATED, function (event) {
                    var layer = event.layer;
                    drawnItems.clearLayers(); // Clear any previously drawn shapes
                    drawnItems.addLayer(layer);

                    var latLngs = layer.getLatLngs()[0];

                    // Check if the first and last points are the same
                    if (latLngs[0] !== latLngs[latLngs.length - 1]) {
                        latLngs.push(latLngs[0]); // Add the first point at the end to close the polygon
                    }

                    // Convert polygon to WKT format
                    var coordinates = latLngs.map(function (point) {
                        return point.lng + " " + point.lat;
                    }).join(", ");
                    var wkt = `POLYGON((${coordinates}))`;
                    $('#hdnMapdata').val(wkt);
                });

                // Handle edit event
                map.on(L.Draw.Event.EDITED, function (event) {
                    var layers = event.layers;
                    layers.eachLayer(function (layer) {

                        var editedGeoJson = layer.toGeoJSON();

                        // Convert edited GeoJSON to WKT
                        var latLngs = layer.getLatLngs()[0];

                        // Check if the first and last points are the same
                        if (latLngs[0] !== latLngs[latLngs.length - 1]) {
                            latLngs.push(latLngs[0]); // Add the first point at the end to close the polygon
                        }

                        var coordinates = latLngs.map(function (point) {
                            return point.lng + " " + point.lat;
                        }).join(", ");

                        var wkt = `POLYGON((${coordinates}))`;

                        $('#hdnMapdata').val(wkt);
                    });
                });

                // $('#AddZoneManagementModal').on('shown.bs.modal', function () {
                //     Createmap.invalidateSize();
                // });
            });
        }


        function ConvertGeoJSONtoWKT(geoJsonString) {

            // Parse the GeoJSON string to a JavaScript object
            var geoJson = JSON.parse(geoJsonString);

            // Extract the coordinates array
            var coordinates = geoJson.coordinates[0]; // Assuming single polygon

            // Map the coordinates to "lng lat" strings
            var wktCoordinates = coordinates.map(function (point) {
                return point[0] + " " + point[1]; // lng lat
            });

            // Ensure the polygon is closed by checking the first and last points
            if (wktCoordinates[0] !== wktCoordinates[wktCoordinates.length - 1]) {
                wktCoordinates.push(wktCoordinates[0]); // Close the polygon
            }

            // Join the coordinates with commas and format as WKT
            var wkt = `POLYGON((${wktCoordinates.join(", ")}))`;
            return wkt;
        }
        function ClearZoneManagementModal() {
            $('#txtZone').val("");
            $('#hdnMapdata').val("");

            $("#h4ZoneManagementTitle").html("Add Geomerty Data");
            $("#hdnId").val("0");
            $('#txtType').val("");
        }

        function CloseZoneManagement()
        {
            ClearZoneManagementModal();
            $("#AddEditZone").css('display','none');
            // $('#AddZoneManagementModal').modal('hide');
            // initMap();
            GetAllZoneManagement();
            initMap();
        }
        function SaveZoneManagement() {
            // let valid = formValidation(["txtDeviceName", "txtHeader", "txtDuration"]);
            let valid = formValidation(["txtType","txtZone"]);
            
            if (valid && $("#hdnMapdata").val() !="") {
                var dataObject = {};
                dataObject.Id = $("#hdnId").val();
                dataObject.Zone = $("#txtZone").val();
                dataObject.FeatureGeoJson = $('#hdnMapdata').val();
                dataObject.Type = $('#txtType').val();



                $.ajax({
                    url: CreateUpdateZoneManagementUrl,
                    type: "POST",
                    data: dataObject,  // Send data if needed
                    beforeSend: function () {

                    },
                    success: function (response) {
                        if (response.data) {
                            toastr.success(response.errorMessage);
                            $("#AddEditZone").css('display','none');
                            // $('#AddZoneManagementModal').modal('hide');
                            // initMap();
                            GetAllZoneManagement();
                            initMap();
                        }
                        else {
                            toastr.error(response.errorMessage);
                        }
                        // Handle success (e.g., update UI with response data)
                    },
                    error: function (error) {
                        console.log("Error:", error);
                        toastr.error("Error:" + error);
                    }
                }).done(function () {

                });
            }
            else {
                if(!valid)
                {
                toastr.warning("Please fill in required field(s)");
                }
                else
                {
                    toastr.warning("Please select Map");
                }
            }

        }
    </script>

}